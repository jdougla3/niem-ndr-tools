
SHELL = @bash@ -o pipefail

PACKAGE_NAME = @PACKAGE_NAME@
PACKAGE_VERSION = @PACKAGE_VERSION@
dist_name = $(PACKAGE_NAME)-$(PACKAGE_VERSION)

prefix = @prefix@

#############################################################################
# prerequisite packages
wrtools_core_package_name=wrtools-core
niem_ndr_artifacts_package_name=niem-ndr-artifacts

#############################################################################
# tools
INSTALL = @INSTALL@
MKDIR_P = @MKDIR_P@

find = @find@
m4 = @m4@
tar = @tar@
zip = @zip@

#############################################################################
# package folders & files

TOKENS_DIR = tmp/tokens

src_files = $(shell find src -type f ! -name '*~')
artifacts_files = $(shell find niem-ndr-artifacts -type f ! -name '*~' ! -name .git ! -name README.md)

all_files = \
	$(src_files:src/%=tmp/all/%) \
	$(artifacts_files:niem-ndr-artifacts/%=tmp/all/share/niem-ndr-artifacts/ndr-3.0/%)

#############################################################################
# functions

# invoke with $(call touch,$@)
touch = mkdir -p $(dir $(1)) && touch $(1)

#############################################################################
# recipes

all: $(all_files)

tmp/all/%: src/% m4-header.m4
	$(MKDIR_P) $(dir $@)
	$(m4) -P \
		-DMACRO_PACKAGE_NAME=$(PACKAGE_NAME) \
		-DMACRO_WRTOOLS_CORE_PACKAGE_NAME=$(wrtools_core_package_name) \
		-DMACRO_NIEM_NDR_ARTIFACTS_PACKAGE_NAME=$(niem_ndr_artifacts_package_name) \
		m4-header.m4 $< > $@
	if [[ -x $< ]]; then chmod uog+x $@; fi

install: all
	$(MKDIR_P) $(prefix)
	(cd tmp/all && $(tar) cf - .) | $(tar) -x -C $(prefix)

#############################################################################
# niem-ndr-artifacts

tmp/all/share/niem-ndr-artifacts/ndr-3.0/%: niem-ndr-artifacts/%
	mkdir -p $(dir $@)
	cp $< $@

##################################################################
# cleanup

clean:
	rm -rf tmp pkg
	find . -type f -name 'tmp.*' -print0 | xargs -0 rm -f

distclean: clean
	rm -rf var stow.mk Makefile
	find . -type f -name '*~' -print0 | xargs -0 rm -f


#############################################################################
# zip

.PHONY: zip
zip: tmp/$(dist_name).zip

tmp/$(dist_name).zip: all
	$(MAKE) -f prerequisites.mk
	$(RM) -r tmp/$(dist_name)
	$(MKDIR_P) tmp/$(dist_name)
	(cd tmp/all && $(tar) cf - .) | (cd tmp/$(dist_name) && $(tar) xf -)
	(cd tmp/prerequisites && $(tar) cf - .) | (cd tmp/$(dist_name) && $(tar) xf -)
	cd tmp && $(zip) -9 -r $(dist_name).zip $(dist_name)
